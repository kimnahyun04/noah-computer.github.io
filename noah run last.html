<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Noah Run</title>
<link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2107@1.0/DungGeunMo.css" rel="stylesheet">

<style>
  html, body {
    margin: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    background: black;
  }

  .game-container {
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .game-area {
    position: relative;
    width: calc(100vh * (16 / 9));
    height: 100vh;
    max-width: 100vw;
    max-height: calc(100vw * (9 / 16));
    overflow: hidden;
    background: #000;
  }

  #bg-track {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    white-space: nowrap;
    display: flex;
    

  }



.bgSet {
    position: relative;
    display: block;
    height: 100%;
    flex-shrink: 0;
}

.bgSet img {
    height: 100%;
    width: auto;
    display: block;
    image-rendering: pixelated;
}

  .groundBlock {
    position: absolute;
    height: 5%;
    background: rgba(0, 0, 255, 0);
    pointer-events: none;
    z-index: 5;
  }

  .obstacle {
    position: absolute;
    image-rendering: pixelated;
    z-index: 15;
    width: auto;
    height: auto;
  }

  .noah {
    position: absolute;
    bottom: 10%;
    left: 10%;
    width: 12%;
    height: auto;
    image-rendering: pixelated;
    transform: scaleX(-1);
    z-index: 10;
  }

  #noah-hitbox {
    position: absolute;
    width: 6%;
    height: 9%;
    background: rgba(0, 255, 0, 0);
    pointer-events: none;
    z-index: 99;
  }

  .spark, .sparkLoop {
    position: absolute;
    width: auto;
    height: auto;
    image-rendering: pixelated;
    z-index: 50;
    pointer-events: none;
  }

  .sparkLoop {
    display: none;
  }

  .fallObstacle {
    position: absolute;
    width: 15%;
    height: auto;
    z-index: 40;
    image-rendering: pixelated;
    pointer-events: none;
  }
  .groundObstacle {
    position: absolute;
    width: 15%;
    height: auto;
    z-index: 40;
    image-rendering: pixelated;
    pointer-events: none;
}
.platformBlock {
  position: absolute;
  background: rgba(255, 0, 0, 0); /* ì™„ì „ íˆ¬ëª… */
  pointer-events: none;
  z-index: 99;
}

.bridgeBlock {
  position: absolute;
  image-rendering: pixelated;
  pointer-events: none;
  z-index: 8;
}
.item {
  
  image-rendering: pixelated;

  /* ê¸°ë³¸ ìƒíƒœì—ì„œì˜ í”½ì…€ í…Œë‘ë¦¬ */
  filter:
    brightness(1)
    drop-shadow(0px 0px 0px #ffe45e)
    drop-shadow(1px 0px 0px #ffe45e)
    drop-shadow(-1px 0px 0px #ffe45e)
    drop-shadow(0px 1px 0px #ffe45e)
    drop-shadow(0px -1px 0px #ffe45e);
}



#ending-mask {
  position: absolute;
  top: 0;
  right: 0;
  width: 10%;          /* ê°€ë¦¬ê°œ ë„“ì´ â€” í•„ìš”í•˜ë©´ ì¡°ì ˆ ê°€ëŠ¥ */
  height: 100%;
  pointer-events: none;
  z-index: 999;
  background: linear-gradient(to left, rgba(0,0,0,1), rgba(0,0,0,0));
  display: none;       /* í‰ì†Œì—” ìˆ¨ê¹€ */
}

/* ë‹¤ë¦¬ ë¿…! ë“±ì¥ */
@keyframes bridgePop {
  0%   { transform: scale(0); filter: brightness(2); }
  60%  { transform: scale(1.15); filter: brightness(1.4); }
  100% { transform: scale(1); filter: brightness(1); }
}

@keyframes fadePop {
  0% { transform: scale(0); opacity: 0; }
  60% { transform: scale(1.15); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}

/* =====================
   ë‹¤ì‹œí•˜ê¸° ì˜¤ë²„ë ˆì´
===================== */
#retry-overlay {
  position: absolute;
  inset: 0;
  background: rgba(80, 0, 0, 0.85); /* ğŸ”´ ì•„ì£¼ ì–´ë‘ìš´ ë¹¨ê°• */
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.retry-box {
  font-family: "DungGeunMo";
  text-align: center;
  color: #ffd6d6;                 /* ì—°í•œ í•ë¹› */
  border: 4px solid #ff4d4d;      /* ğŸ”´ ë ˆë“œ í…Œë‘ë¦¬ */
  padding: 4vh 6vh;
  background: #120000;            /* ê±°ì˜ ê²€ì •ì— ê°€ê¹Œìš´ ë ˆë“œ */
  image-rendering: pixelated;
}


.retry-box p {
  font-size: 4vh;
  margin-bottom: 3vh;
}

.retry-box button {
  font-family: "DungGeunMo";
  font-size: 3vh;
  padding: 1.2vh 4vh;
  background: #120000;
  color: #ffb3b3;
  border: 3px solid #ff4d4d;
  cursor: pointer;
}


.retry-box button:hover {
  background: #ff4d4d;   /* ğŸ”¥ í™• ë¹¨ê°• */
  color: black;
}


</style>
</head>
<body>
<audio id="sfx-noah-hit" src="./ë…¸ì•„ ì•„íŒŒí•˜ëŠ” ì†Œë¦¬.mp3"></audio>
<audio id="sfx-fall" src="./ì¥ì• ë¬¼ ì¿µ íš¨ê³¼ìŒ.mp3"></audio>
<audio id="sfx-item" src="./ì•„ì´í…œ ë¨¹ëŠ”ì†Œë¦¬.mp3"></audio>
<audio id="sfx-bridge" src="./ë‹¤ë¦¬ ë¿….mp3"></audio>
<audio id="sfx-paper" src="./ì¢…ì´ ê°ˆê¸°.mp3" loop></audio>
<audio id="sfx-electric" src="./ì „ê¸° ì¥ì• ë¬¼ ì†Œë¦¬.mp3"></audio>
<audio id="sfx-blue" src="./ë¸”ë£¨ ì¥ì• ë¬¼ 1ì†Œë¦¬.mp3"></audio>
<audio id="sfx-blue5" src="./ë¸”ë£¨ ì¥ì• ë¬¼ 2ì†Œë¦¬.mp3" loop></audio>
<audio id="sfx-windows" src="./ìœˆë„ìš°-ì†¡.mp3"></audio>


<audio id="bgm" src="./ë…¸ì•„ ë‹¬ë¦¬ê¸° ìŒì•….mp3" loop></audio>
<div class="game-container">
  <div class="game-area" id="game-area">
    <div id="bg-track"></div>

    <img src="./ë…¸ì•„ ë‹¬ë¦¼.gif" class="noah" id="noah">
    <div id="ending-mask"></div>

    <div id="noah-hitbox"></div>
    <!-- =====================
   ë‹¤ì‹œí•˜ê¸° ì˜¤ë²„ë ˆì´
===================== -->
<div id="retry-overlay">
  <div class="retry-box">
    <p>ë‹¤ì‹œ í•˜ê² ìŠµë‹ˆê¹Œ?</p>
    <button id="retry-btn">RETRY</button>
  </div>
</div>

  </div>
</div>

<script>

const DEBUG_MODE = 0;

const bgm = document.getElementById("bgm");

function tryPlayBGM() {
  bgm.volume = 0.6;
  const playPromise = bgm.play();
  if (playPromise !== undefined) {
    playPromise.catch(() => {
      console.log("â–¶ï¸ ìë™ì¬ìƒ ì‹¤íŒ¨ â†’ í‚¤ ì…ë ¥ ì‹œ ì¬ìƒ ì˜ˆì •");
    });
  }
}

tryPlayBGM();

window.addEventListener("keydown", () => {
  unlockAllAudio();   // â­ ì´ ì¤„ì´ í•µì‹¬
  if (bgm.paused) bgm.play();
}, { once: true });


const sfxFall = document.getElementById("sfx-fall");

function playFallSFX() {
  sfxFall.currentTime = 0; 
  sfxFall.play().catch(() => {});
}
const sfxItem = document.getElementById("sfx-item");

function playItemSFX() {
  const now = performance.now();

  // â­ 0.1ì´ˆ ì•ˆì— ë˜ ìš¸ë¦¬ë ¤ í•˜ë©´ ë¬´ì‹œ
  if (now - lastItemSoundTime < 100) return;

  lastItemSoundTime = now;

  const sound = sfxItem.cloneNode();
  sound.volume = 0.6;   // ğŸ”‰ ì†Œë¦¬ ìì²´ë„ ì‚´ì§ ë‚®ì¶¤
  sound.play().catch(() => {});
}

const sfxBridge = document.getElementById("sfx-bridge");
const sfxPaper = document.getElementById("sfx-paper");
const sfxElectric = document.getElementById("sfx-electric");
const sfxBlue = document.getElementById("sfx-blue");
const sfxBlue5 = document.getElementById("sfx-blue5");
const sfxWindows = document.getElementById("sfx-windows");

let stage5BluePlaying = false;
let stage6BlueStopScheduled = false;


let electricCount0 = 0; // 3ë²ˆ ë°°ê²½ 0íšŒ
let electricCount1 = 0; // 3ë²ˆ ë°°ê²½ 1íšŒ

let blueCount0 = 0; // 4ë²ˆ ë°°ê²½ 0íšŒ
let blueCount1 = 0; // 4ë²ˆ ë°°ê²½ 1íšŒ

function playElectricSFX() {
  const sound = sfxElectric.cloneNode();
  sound.volume = 0.6;
  sound.play().catch(() => {});
}

function playBlueSFX() {
  const sound = sfxBlue.cloneNode();
  sound.volume = 0.6;
  sound.play().catch(() => {});
}

function playWindowsPopupSFX() {
  const sound = sfxWindows.cloneNode();
  sound.volume = 0.5;
  sound.play().catch(() => {});
}


function playBridgeSFX() {
  const sound = sfxBridge.cloneNode(); // â­ ë¿…!ë„ ê²¹ì³ë„ OK
  sound.volume = 0.7;
  sound.play().catch(() => {});
}


const sfxNoahHit = document.getElementById("sfx-noah-hit");

function playNoahHitSFX() {
  sfxNoahHit.currentTime = 0;
  sfxNoahHit.play().catch(() => {});
}


const bgImages = [
  { num: 1, src: "./ë…¸ì•„ ë‹¬ë¦¬ê¸° 1.png" },
  { num: 2, src: "./ë…¸ì•„ ë‹¬ë¦¬ê¸° 2.png" },
  { num: 3, src: "./ë…¸ì•„ ë‹¬ë¦¬ê¸° 3.png" },
  { num: 4, src: "./ë…¸ì•„ ë‹¬ë¦¬ê¸° 4.png" },
  { num: 5, src: "./ë…¸ì•„ ë‹¬ë¦¬ê¸° 5.png" },
  { num: 6, src: "./ë…¸ì•„ ë‹¬ë¦¬ê¸° ë§ˆì§€ë§‰.png" }
];

const groundBlocksInfo = {
  1: [
    { left:"0%", bottom:"13%", width:"100%" }
  ],
  2: [
    { left:"0%", bottom:"13%", width:"21%" },
    { left:"40%", bottom:"13%", width:"26%" },
    { left:"79.5%", bottom:"13%", width:"30%" }
  ],
  3: [
    { left:"0%", bottom:"13%", width:"24.6%" },
    { left:"59%", bottom:"13%", width:"45%" }
  ],
  4: [
    { left:"0%", bottom:"13%", width:"24.6%" },
    { left:"44%", bottom:"13%", width:"20%" },
    { left:"81.3%", bottom:"13%", width:"20%" }
  ],
  5: [
    { left:"0%", bottom:"13%", width:"24.6%" },
    { left:"44%", bottom:"13%", width:"20%" },
    { left:"81.3%", bottom:"13%", width:"20%" }
  ],
  6: [
    { left:"0%", bottom:"13%", width:"100%" }
  ],
};

const obstacleInfo = {
  1: [],
  2: [
    { left: "20%", bottom: "-1%", width: "11%", height:"20%" },
    { left: "30%", bottom: "-1%", width: "11%", height:"20%" },
    { left: "65.2%", bottom: "-1%", width: "15%", height:"25%" }
  ],
  3: [],
  4: [],
  5: [],
  6: []
};

const lightningInfo = {
  2: [],
  3: [
    { left: "24%", bottom: "0%", width: "20%", height:"55%" },
    { left: "40%", bottom: "0%", width: "20%", height:"55%" }
  ]
};

const fallObstacleInfo = {
  1: [
    { left:"20%", startTop:"-70%", landBottom:"-14%", delay: 2000 }
  ],
  2: [],
  3: [],
  4: [],
  5: [],
  6: [{ left:"0%",  startTop:"-70%", landBottom:"0%", delay:  300 }
    ]
};
const bridgeInfo = {
  2: [
    { left:"27.5%", bottom:"4%", width:"50%", height:"60%" }
  ]
};
const platformInfo = {
  2: [
    { left:"38.5%", bottom:"31.6%", width:"28%", height:"5%" } // ì¶©ëŒ ë°•ìŠ¤
  ]
};
/* ==========================================
   â­ ë¸”ë£¨ìŠ¤í¬ë¦° ìœ„ì¹˜/í¬ê¸° ì„¤ì • (ì§ì ‘ ì¡°ì ˆí•˜ëŠ” ë¶€ë¶„)
========================================== */
const blueScreens = [
  { left: "-10%", top: "1%", width: "50%", height: "70%" },
  { left: "0%", top: "10%", width: "50%", height: "70%" },
  { left: "10%", top: "1%", width: "50%", height: "70%" },
  { left: "20%", top: "10%",  width: "50%", height: "70%" },
  { left: "30%", top: "1%",  width: "50%", height: "70%" },
  { left: "40%", top: "10%", width: "50%", height: "70%" },
  { left: "50%", top: "1%", width: "50%", height: "70%" },
  { left: "60%", top: "10%", width: "50%", height: "70%" },
  { left: "70%", top: "1%", width: "50%", height: "70%" },
  { left: "80%", top: "10%", width: "50%", height: "70%" }
];
const blueScreens5 = [
  { left: "-10%", top: "1%", width: "50%", height: "70%" },
  { left: "0%", top: "10%", width: "50%", height: "70%" },
  { left: "10%", top: "1%", width: "50%", height: "70%" },
  { left: "20%", top: "10%",  width: "50%", height: "70%" },
  { left: "30%", top: "1%",  width: "50%", height: "70%" },
  { left: "40%", top: "10%", width: "50%", height: "70%" },
  { left: "50%", top: "1%", width: "50%", height: "70%" },
  { left: "60%", top: "10%", width: "50%", height: "70%" },
  { left: "70%", top: "1%", width: "50%", height: "70%" },
  { left: "80%", top: "10%", width: "50%", height: "70%" }
];

const stage4BlueObstacle = [
  { left: "24%", bottom: "0%", width: "20%", height: "40%" },
  { left: "63.5%", bottom: "0%", width: "18%", height: "36%" }
];

const stage5BlueObstacle = [
  { left: "24.5%", bottom: "0%", width: "20%", height: "40%" },
  { left: "63.5%", bottom: "0%", width: "18%", height: "36%" },
];

const itemInfo = {
  1: [
    { type: 1, left: "0%", bottom: "20%" },
    { type: 1, left: "5%", bottom: "20%" },
    { type: 1, left: "10%", bottom: "20%" },
    { type: 1, left: "15%", bottom: "20%" },
    { type: 1, left: "20%", bottom: "20%" },
    { type: 1, left: "25%", bottom: "20%" },
    { type: 1, left: "30%", bottom: "20%" },
    { type: 1, left: "35%", bottom: "20%" },
    { type: 1, left: "40%", bottom: "20%" },
    { type: 1, left: "45%", bottom: "20%" },
    { type: 1, left: "50%", bottom: "20%" },
    { type: 1, left: "55%", bottom: "20%" },
    { type: 1, left: "60%", bottom: "20%" },
    { type: 1, left: "65%", bottom: "20%" },
    { type: 1, left: "70%", bottom: "20%" },
    { type: 1, left: "75%", bottom: "20%" },
    { type: 1, left: "80%", bottom: "20%" },
    { type: 1, left: "85%", bottom: "20%" },
    { type: 1, left: "90%", bottom: "20%" },
    { type: 1, left: "95%", bottom: "20%" },
  ],
  2: [
    { type: 2, left: "0%", bottom: "20%" },
    { type: 2, left: "5%", bottom: "20%" },
    { type: 2, left: "10%", bottom: "20%" },
    { type: 2, left: "15%", bottom: "20%" },
    { type: 2, left: "20%", bottom: "25%" },
    { type: 2, left: "25%", bottom: "30%" },
    { type: 2, left: "30%", bottom: "35%" },
    { type: 2, left: "35%", bottom: "40%" },
    { type: 2, left: "40%", bottom: "40%" },
    { type: 2, left: "45%", bottom: "40%" },
    { type: 2, left: "50%", bottom: "40%" },
    { type: 2, left: "55%", bottom: "40%" },
    { type: 2, left: "60%", bottom: "40%" },
    { type: 2, left: "65%", bottom: "40%" },
    { type: 2, left: "70%", bottom: "35%" },
    { type: 2, left: "75%", bottom: "30%" },
    { type: 2, left: "80%", bottom: "25%" },
    { type: 2, left: "85%", bottom: "20%" },
    { type: 2, left: "90%", bottom: "20%" },
    { type: 2, left: "95%", bottom: "20%" },

    
  ],
  3: [{ type: 3, left: "0%", bottom: "20%" },
    { type: 3, left: "5%", bottom: "20%" },
    { type: 3, left: "10%", bottom: "20%" },
    { type: 3, left: "15%", bottom: "20%" },
    
    { type: 3, left: "25%", bottom: "55%" },
    { type: 3, left: "30%", bottom: "55%" },
    { type: 3, left: "35%", bottom: "55%" },
    { type: 3, left: "40%", bottom: "55%" },
    { type: 3, left: "45%", bottom: "55%" },
    { type: 3, left: "50%", bottom: "55%" },
    
    { type: 3, left: "60%", bottom: "20%" },
    { type: 3, left: "65%", bottom: "20%" },
    { type: 3, left: "70%", bottom: "20%" },
    { type: 3, left: "75%", bottom: "20%" },
    { type: 3, left: "80%", bottom: "20%" },
    { type: 3, left: "85%", bottom: "20%" },
    { type: 3, left: "90%", bottom: "20%" },
    { type: 3, left: "95%", bottom: "20%" },],

  4: [{ type: 4, left: "0%", bottom: "20%" },
    { type: 4, left: "5%", bottom: "20%" },
    { type: 4, left: "10%", bottom: "20%" },
    { type: 4, left: "15%", bottom: "20%" },
    { type: 4, left: "20%", bottom: "20%" },
    
    { type: 4, left: "44%", bottom: "20%" },
    { type: 4, left: "49%", bottom: "20%" },
    { type: 4, left: "54%", bottom: "20%" },
    { type: 4, left: "59%", bottom: "20%" },
    
    { type: 4, left: "80%", bottom: "20%" },
    { type: 4, left: "85%", bottom: "20%" },
    { type: 4, left: "90%", bottom: "20%" },
    { type: 4, left: "95%", bottom: "20%" },],

  5: [{ type: 4, left: "0%", bottom: "20%" },
    { type: 4, left: "5%", bottom: "20%" },
    { type: 4, left: "10%", bottom: "20%" },
    { type: 4, left: "15%", bottom: "20%" },
    { type: 4, left: "20%", bottom: "20%" },
    
    { type: 4, left: "44%", bottom: "20%" },
    { type: 4, left: "49%", bottom: "20%" },
    { type: 4, left: "54%", bottom: "20%" },
    { type: 4, left: "59%", bottom: "20%" },
    
    { type: 4, left: "80%", bottom: "20%" },
    { type: 4, left: "85%", bottom: "20%" },
    { type: 4, left: "90%", bottom: "20%" },
    { type: 4, left: "95%", bottom: "20%" },],
  6: []
};

const itemImages = {
  1: "./ë‹¬ë¦¬ê¸° ì•„ì´í…œ 1.png",
  2: "./ë‹¬ë¦¬ê¸° ì•„ì´í…œ 2.png",
  3: "./ë‹¬ë¦¬ê¸° ì•„ì´í…œ 3.png",
  4: "./ë‹¬ë¦¬ê¸° ì•„ì´í…œ 4.png"
};

/* =====================================
   3) ì•„ì´í…œ ì ìˆ˜ (ì›í•˜ë©´ ë‚˜ì¤‘ì— ìˆ˜ì •)
===================================== */
const itemScore = {
  1: 50,
  2: 100,
  3: 150,
  4: 200
};
const gameArea = document.getElementById("game-area");
const bgTrack = document.getElementById("bg-track");



/* ==========================================================
   â­ ë°ë¯¸ì§€ í•¨ìˆ˜ (ë°˜ë“œì‹œ gameLoop ìœ„ì— ìˆì–´ì•¼ í•¨)
========================================================== */
function handleFallingObstacleHit() {
  playNoahHitSFX();  // ğŸ”¥ ë…¸ì•„ ë¹„ëª… ì¶”ê°€!

  // 1) ë°°ê²½ + ê²Œì„ ì „ì²´ ì •ì§€(JS ê¸°ì¤€)
  isPaused = true;

  // 2) ë…¸ì•„ ë°ë¯¸ì§€ GIF
  noah.src = "./ë…¸ì•„ ë‹¬ë¦¬ë‹¤ê°€ ì•„í””.gif";

  resetNoahToGround();

  // 3) ê¹œë¹¡ì„ (í”¼ê²© ì—°ì¶œ)
  let blinkCount = 0;
  const blink = setInterval(() => {
    noah.style.visibility =
      noah.style.visibility === "hidden" ? "visible" : "hidden";
    blinkCount++;
    if (blinkCount > 10) {
      clearInterval(blink);
      noah.style.visibility = "visible";
    }
  }, 80);

  // 4) 1ì´ˆ ë’¤ ê²Œì„ ì¬ê°œ
  setTimeout(() => {
    // ë…¸ì•„ ë‹¤ì‹œ ë‹¬ë¦¬ëŠ” ìƒíƒœ
    noah.src = "./ë…¸ì•„ ë‹¬ë¦¼.gif";

    // ë°°ê²½ ë‹¤ì‹œ ì›€ì§ì„
    isPaused = false;

  }, 1000);
}


function resetNoahToGround() {
  const grounds = document.querySelectorAll(".groundBlock");
  const hb = hitbox.getBoundingClientRect();
  let highest = -9999;

  for (let g of grounds) {
    const r = g.getBoundingClientRect();
    if (hb.right > r.left && hb.left < r.right) {
      if (r.top > highest) highest = r.top;
    }
  }

  if (highest > -9999) {
    const groundTopVH = (window.innerHeight - highest) / window.innerHeight * 100;
    y = groundTopVH - 10;
    vy = 0;
    onGround = true;
    noah.style.bottom = (groundTopVH - 10) + "%";
  }
}


/* ==========================================================
      ë–¨ì–´ì§€ëŠ” ì¥ì• ë¬¼ ìŠ¤í° í•¨ìˆ˜ (ADDSETë³´ë‹¤ ìœ„ì— ìˆì–´ì•¼ í•¨)
========================================================== */

function spawnFallingObstacle(info, parentSet, stageNum) {
  const obs = document.createElement("img");
  if (stageNum === 6) {
    obs.src = "./ë‹¬ë¦¬ê¸° ë³´ìŠ¤ ì¿µ.gif";  // â† ë‚˜í˜„ì´ ì¤€ ì´ë¯¸ì§€
} else {
    obs.src = "./ì¥ì• ë¬¼ ì¿µ.gif";
}

  obs.className = "fallObstacle";
 
 let dropLeft;

// â­ 6ë²ˆ ë°°ê²½: ë…¸ì•„ ë°”ë¡œ ë’¤ì—ì„œ ë–¨ì–´ì§€ê¸°
if (stageNum === 6) {
    dropLeft = (noahX - 15) + "%";
}

// â­ 1ë²ˆ ë°°ê²½: ë…¸ì•„ ê¸°ì¤€ 25% ì•ì—ì„œ ë–¨ì–´ì§€ê¸°
else if (stageNum === 1) {
    dropLeft = (noahX + 25) + "%";
}

// â­ ë‚˜ë¨¸ì§€ ë°°ê²½: info.left ê·¸ëŒ€ë¡œ ì‚¬ìš©
else {
    dropLeft = info.left;
}

obs.style.left = dropLeft;


  obs.style.top = info.startTop;
  parentSet.appendChild(obs);
if (stageNum === 6) {
    const balloon = document.createElement("div");
    balloon.innerText = "catch me !";

    // í™”ë©´ ì „ì²´ ê¸°ì¤€ ìœ„ì¹˜ (%)
    const balloonLeft = noahX + 3;   // ë…¸ì•„ ìœ„ì¹˜ ê¸°ì¤€ ì˜†ìœ¼ë¡œ ì‚´ì§
    const balloonTop  = 35;          // í™”ë©´ 35% ë†’ì´

    balloon.style.position = "absolute";
    balloon.style.left = balloonLeft + "%";
    balloon.style.top = balloonTop + "%";

    balloon.style.fontFamily = "DungGeunMo";
    balloon.style.color = "#ffffff";
    balloon.style.fontSize = "3vh";
    balloon.style.padding = "0.8vh 1.2vh";
    balloon.style.background = "rgba(0,0,0,0.8)";
    balloon.style.border = "0.3vh solid white";
    balloon.style.borderRadius = "1vh";
    balloon.style.imageRendering = "pixelated";
    balloon.style.pointerEvents = "none";
    balloon.style.zIndex = "9999";

    balloon.style.animation = "fadePop 1.2s ease-out forwards";

    // â­ ë°˜ë“œì‹œ gameAreaì— ë¶™ì—¬ì•¼ í™”ë©´ì— ë¬´ì¡°ê±´ ë³´ì„
    document.getElementById("game-area").appendChild(balloon);

    setTimeout(() => balloon.remove(), 1400);
}


  let fallSpeed = 0;
  let gravity = 0.1;

  function fall() {
    fallSpeed += gravity;

    let currentTop = parseFloat(obs.style.top);
    const land = parseFloat(info.landBottom);

    obs.style.top = (currentTop + fallSpeed) + "%";

    if (currentTop + fallSpeed >= land) {
      playFallSFX();
      obs.style.top = land + "%";
      obs.classList.remove("fallObstacle");
      obs.classList.add("groundObstacle");

      if (stageNum === 6) screenShake();
      return;
    }

    requestAnimationFrame(fall);
  }

  fall();
}





/* ==========================================================
      â­â­â­ bgSet ìƒì„± (ground / ì¥ì• ë¬¼ / ë²ˆê°œ / ì¿µ ì¥ì• ë¬¼)
========================================================== */

function addSet() {
  bgImages.forEach((bg, idx) => {
    if (DEBUG_MODE !== 0 && idx !== (DEBUG_MODE - 1)) return;

    for (let i = 0; i < 2; i++) {
       const isFirstSet = (i === 0);
      const bgSet = document.createElement("div");
      bgSet.className = "bgSet";
      
      if (bg.num === 6 && i === 0) bgSet.id = "stage6";          // ì²« ë°˜ë³µ
      if (bg.num === 6 && i === 1) bgSet.id = "stage6-repeat";   // ë‘ ë²ˆì§¸ ë°˜ë³µ

// â­ ì—”ë”© ì‹œì‘: ì˜¤ë¥¸ìª½ ê·¸ë¼ë°ì´ì…˜ ê°€ë¦¬ê°œ í‘œì‹œ
document.getElementById("ending-mask").style.display = "block";



      const img = document.createElement("img");
      img.src = bg.src;
      bgSet.appendChild(img);
// â­ 2ë²ˆ ë°°ê²½ íŠ¸ë¦¬ê±° (ì²« ë²ˆì§¸ ì„¸íŠ¸ë§Œ)
if (bg.num === 2 && i === 0) bgSet.id = "stage2-trigger";

// 3ë²ˆ ë°°ê²½ì´ í™”ë©´ì— ë“±ì¥í•˜ëŠ” i=0ì— ID ë¶€ì—¬
if (bg.num === 3 && i === 0) bgSet.id = "stage3-trigger-1";
if (bg.num === 3 && i === 1) bgSet.id = "stage3-trigger-2";

// addSet() ì•ˆ
if (bg.num === 4 && i === 0) bgSet.id = "stage4-trigger";
if (bg.num === 4 && i === 1) bgSet.id = "stage4-trigger-repeat";


// addSet() ì•ˆ
if (bg.num === 5 && i === 0) bgSet.id = "stage5-trigger";


// 4ë²ˆ / 5ë²ˆ ë°°ê²½ì˜ "í™”ë©´ì— ë³´ì´ëŠ” ì„¸íŠ¸"ì— ID ë¶™ì´ê¸°
// 4ë²ˆ / 5ë²ˆ ë°°ê²½ì´ ì²˜ìŒ í™”ë©´ì— ë“±ì¥í•˜ëŠ” i=0 ì— ID ë¶€ì—¬
if (bg.num === 4 && i === 0) bgSet.id = "stage4-trigger";
if (bg.num === 5 && i === 0) bgSet.id = "stage5-trigger";


      /* ground */
      if (groundBlocksInfo[bg.num]) {
        groundBlocksInfo[bg.num].forEach(g => {
          const gb = document.createElement("div");
          gb.className = "groundBlock";
          gb.style.left = g.left;
          gb.style.bottom = g.bottom;
          gb.style.width = g.width;
          bgSet.appendChild(gb);
        });
      }

      /* ê¸°ë³¸ ì¥ì• ë¬¼ */
      if (obstacleInfo[bg.num]) {
        obstacleInfo[bg.num].forEach(o => {
          const ob = document.createElement("img");
          ob.src = "./ë‹¬ë¦¬ê¸° ì¥ì• ë¬¼.gif";
          ob.className = "obstacle";
          ob.style.left = o.left;
          ob.style.bottom = o.bottom;
          ob.style.width = o.width;
          if (o.height) ob.style.height = o.height;
          bgSet.appendChild(ob);
        });
      }

      /* ë²ˆê°œ */
if (lightningInfo[bg.num]) {
  lightningInfo[bg.num].forEach(l => {

    const spark = document.createElement("img");
    spark.src = "./ë‹¬ë¦¬ê¸° ì¥ì• ë¬¼ ë²ˆê°œ.gif";
    spark.className = "spark";
    spark.style.left = l.left;
    spark.style.bottom = l.bottom;
    if (l.width) spark.style.width = l.width;
    if (l.height) spark.style.height = l.height;
    bgSet.appendChild(spark);

    const sparkLoop = document.createElement("img");
    sparkLoop.src = "./ë‹¬ë¦¬ê¸° ì¥ì• ë¬¼ ë²ˆê°œ 2.gif";
    sparkLoop.className = "sparkLoop";
    sparkLoop.style.left = l.left;
    sparkLoop.style.bottom = l.bottom;
    if (l.width) sparkLoop.style.width = l.width;
    if (l.height) sparkLoop.style.height = l.height;

    sparkLoop.style.display = "none";   // â­ ì²˜ìŒì—” ìˆ¨ê¹€!

    bgSet.appendChild(sparkLoop);

  });
}

    /* ë‹¤ë¦¬(bridge) */
if (bridgeInfo[bg.num]) {
  bridgeInfo[bg.num].forEach(b => {
    const br = document.createElement("div");
    br.className = "bridgeBlock";
    br.style.left = b.left;
    br.style.bottom = b.bottom;
    br.style.width = b.width;
    br.style.height = b.height;
    br.style.backgroundImage = "url('./ë…¸ì•„ ë‹¬ë¦¬ê¸° ë‹¤ë¦¬.png')";
    br.style.backgroundSize = "100% 100%";
    br.style.imageRendering = "pixelated";
    br.style.position = "absolute";
    br.style.zIndex = "8";
    bgSet.appendChild(br);
  });
}
if (platformInfo[bg.num]) {
  platformInfo[bg.num].forEach(p => {
    const pf = document.createElement("div");
    pf.className = "platformBlock";
    pf.style.left = p.left;
    pf.style.bottom = p.bottom;
    pf.style.width = p.width;
    pf.style.height = p.height;
    pf.style.position = "absolute";
    pf.style.zIndex = "99";

    // í™•ì¸ìš© ìƒ‰ â€” ë‚˜ì¤‘ì— íˆ¬ëª…ìœ¼ë¡œ ë°”ê¾¸ë©´ ë¨
    pf.style.background = "rgba(255,0,0,0)";

    bgSet.appendChild(pf);
  });
}
/* â­ 4ë²ˆ ë°°ê²½ ë¸”ë£¨ìŠ¤í¬ë¦° ì¥ì• ë¬¼ */
if (bg.num === 4) {
  stage4BlueObstacle.forEach(o => {
    const ob = document.createElement("img");
    ob.src = "./ë¸”ë£¨ ì¥ì• ë¬¼.gif";   // 4ë²ˆ ì „ìš© ì´ë¯¸ì§€
    ob.className = "obstacle-stage4";

    ob.style.position = "absolute";
    ob.style.left = o.left;
    ob.style.bottom = o.bottom;
    ob.style.width = o.width;
    ob.style.height = o.height;
    
    ob.style.imageRendering = "pixelated";

    bgSet.appendChild(ob);
  });
}
/* â­ 5ë²ˆ ë°°ê²½ ë¸”ë£¨ìŠ¤í¬ë¦° ì¥ì• ë¬¼ */
if (bg.num === 5) {
  stage5BlueObstacle.forEach(o => {
    const ob = document.createElement("img");
    ob.src = "./ë¸”ë£¨ ì¥ì• ë¬¼ 2.gif";  // 5ë²ˆ ì „ìš© ì´ë¯¸ì§€
    ob.className = "obstacle-stage5";

    ob.style.position = "absolute";
    ob.style.left = o.left;
    ob.style.bottom = o.bottom;
    ob.style.width = o.width;
    ob.style.height = o.height;
    
    ob.style.imageRendering = "pixelated";

    bgSet.appendChild(ob);
  });
}

/* ====== ì•„ì´í…œ ìƒì„± ====== */
if (itemInfo[bg.num]) {
  itemInfo[bg.num].forEach(it => {
    const item = document.createElement("img");
    item.className = "item";
    item.dataset.type = it.type;
    item.src = itemImages[it.type];

    item.style.left = it.left;
    item.style.bottom = it.bottom;
    item.style.width = "5%";
    item.style.height = "10%";
    item.style.position = "absolute";
    item.style.zIndex = "20";
    item.style.imageRendering = "pixelated";

    bgSet.appendChild(item);
  });
}


 /* ë–¨ì–´ì§€ëŠ” ì¥ì• ë¬¼ */
// â­ 6ë²ˆ ë°°ê²½: i === 0, 1 ì—ì„œë§Œ í—ˆìš©, i === 2 ëŠ” ê¸ˆì§€
/* â­ ë–¨ì–´ì§€ëŠ” ì¥ì• ë¬¼ ìƒì„± ë¡œì§ (ìµœì¢… ì™„ì„± ë²„ì „) */


// â­ 1~5ë²ˆ ë°°ê²½ë§Œ ìë™ ìƒì„±
if (bg.num >= 1 && bg.num <= 5 && fallObstacleInfo[bg.num]) {
    fallObstacleInfo[bg.num].forEach(f => {
        setTimeout(() => {
            spawnFallingObstacle(f, bgSet, bg.num);
        }, f.delay || 0);
    });
}




      bgTrack.appendChild(bgSet);
    }
  });
}

addSet();
function fadeOutPaperSound(duration = 800) {
  const startVolume = sfxPaper.volume;
  const startTime = performance.now();

  function fade(now) {
    const progress = Math.min((now - startTime) / duration, 1);
    sfxPaper.volume = startVolume * (1 - progress);

    if (progress < 1) {
      requestAnimationFrame(fade);
    } else {
      sfxPaper.pause();
      sfxPaper.currentTime = 0;
      sfxPaper.volume = startVolume; // ë‹¤ìŒ ì¬ìƒ ëŒ€ë¹„ ë³µêµ¬
    }
  }

  requestAnimationFrame(fade);
}

function checkStage2PaperSound() {
  if (!audioUnlocked) return;

  const stage2 = document.getElementById("stage2-trigger");
  const stage3 = document.getElementById("stage3-trigger-1"); // â­ 3ë²ˆ ë°°ê²½ 0íšŒ
  if (!stage2) return;

  const r2 = stage2.getBoundingClientRect();

  // â–¶ï¸ ì‹œì‘: 2ë²ˆ ë°°ê²½ì´ í™”ë©´ì— ë“¤ì–´ì˜¤ë©´ (ê¸°ì¡´ ìœ ì§€)
  if (r2.left < window.innerWidth && !stage2PaperPlaying) {
    stage2PaperPlaying = true;
    sfxPaper.currentTime = 0;
    sfxPaper.volume = 0.4;
    sfxPaper.play().catch(() => {});
  }

  // ğŸ”‡ ì¢…ë£Œ: 3ë²ˆ ë°°ê²½ì´ "ì¡°ê¸ˆ ì§„í–‰ëœ ë’¤"
  if (stage3 && stage2PaperPlaying) {
    const r3 = stage3.getBoundingClientRect();

    // â­ 3ë²ˆ ë°°ê²½ì´ í™”ë©´ì˜ 30% ì§€ì ê¹Œì§€ ë“¤ì–´ì˜¤ë©´
    if (r3.left < window.innerWidth * 0.3) {
      stage2PaperPlaying = false;
      fadeOutPaperSound(900); // â­ ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ì–´ë“¤ë©° ì¢…ë£Œ
    }
  }
}


function unlockAllAudio() {
  if (audioUnlocked) return;
  audioUnlocked = true;

  // âŒ bgm ì œê±°!
  [sfxPaper].forEach(audio => {
    audio.volume = 0;
    audio.play().then(() => {
      audio.pause();
      audio.currentTime = 0;
      audio.volume = 1;
    }).catch(() => {});
  });
}

/* ==========================
   â­ ì—”ë”© ìë™ ë‹¬ë¦¬ê¸° í•¨ìˆ˜
========================== */
function triggerFinalRun() {
    isPaused = true;
    finalRun = true;

    noah.style.transform = "scaleX(-1)";
    setNoahAction("run");

    noahX = (noah.offsetLeft / gameArea.offsetWidth) * 100;
}
 /* ===================================================================
   Noah ë™ì‘
=================================================================== */

let currentAction = "run";
const runGIF = "./ë…¸ì•„ ë‹¬ë¦¼.gif";
const jumpGIF = "./ë…¸ì•„ ë‹¬ë¦¼ ì í”„.gif";
const slideGIF = "./ë…¸ì•„ ë‹¬ë¦¼ ìŠ¬ë¼ì´ë“œ.gif";

function setNoahAction(action) {
  if (currentAction === action) return;
  currentAction = action;

  // ğŸ”¹ GIF ë³€ê²½
  if (action === "run")  noah.src = runGIF;
  if (action === "jump") noah.src = jumpGIF;
  if (action === "slide") noah.src = slideGIF;

  // ğŸ”¹ ìŠ¬ë¼ì´ë“œ = í‚¤ ë‚®ì¶”ê¸°
  if (action === "slide") {
    hitbox.style.height = "6%";      // ë°˜ì¯¤ ë‚®ì•„ì§
    hitbox.style.bottom = (10 + y) + "%";
  } 
  // ğŸ”¹ ì í”„/ë‹¬ë¦¬ê¸° = ì›ë˜ í‚¤ ë³µêµ¬
  else {
    hitbox.style.height = "9%";        // ì›ë˜ ë†’ì´
    hitbox.style.bottom = (10 + y) + "%";
  }

  noah.style.transform = "scaleX(-1)";
}

const noah = document.getElementById("noah");
const hitbox = document.getElementById("noah-hitbox");

let isPaused = false;
let y = 20;
let vy = 0;
let onGround = true;
let isDead = false;
let finalRun = false;   // ì—”ë”© ìë™ ë‹¬ë¦¬ê¸° ëª¨ë“œ ì—¬ë¶€
let noahX = 10;    
let stage3Spawn0 = false; // i=0 ë°˜ë³µìš©
let stage3Spawn1 = false; // i=1 ë°˜ë³µìš©
let stage6Fall0 = false; // 6ë²ˆ i=0 ì¿µ ë–¨ì–´ì§ ì—¬ë¶€
let stage6Fall1 = false; // 6ë²ˆ i=1 ì¿µ ë–¨ì–´ì§ ì—¬ë¶€
let disableTriggersUntil = 0;
let lastItemSoundTime = 0;
let stage2PaperPlaying = false; // â­ 2ë²ˆ ë°°ê²½ ì¢…ì´ê°ˆê¸° ì‚¬ìš´ë“œ ìƒíƒœ
let audioUnlocked = false;



window.addEventListener("keydown", (e) => {
  if (isDead) return;
  if (e.code === "Space" && onGround) {
    vy = 1.4;
    onGround = false;
    setNoahAction("jump");
  }
  if (e.code === "ArrowDown") setNoahAction("slide");
});

window.addEventListener("keyup", (e) => {
  if (isDead) return;
  if (e.code === "ArrowDown" && currentAction === "slide") {
    setNoahAction("run");
  }
});

let bgX = 0;
let bgSpeed = window.innerWidth * 0.004;

function moveBackground() {
  bgSpeed = window.innerWidth * 0.004;  // ë§¤ í”„ë ˆì„ ìë™ ë³´ì •
  bgX -= bgSpeed;
  bgTrack.style.transform = `translateX(${bgX}px)`;

  checkStage6Exit();
}


function checkStage6Exit() {
  const s6 = document.getElementById("stage6");
  if (!s6) return;

  const rect = s6.getBoundingClientRect();

  if (rect.right <= 0) {
    triggerFinalRun();
}

}

// =====================================================
//   ğŸ”¥ ë””ë²„ê·¸ìš© ì •ì§€(P) / ì¬ìƒ(R) í•«í‚¤ 
// =====================================================
window.addEventListener("keydown", (e) => {
  if (e.code === "KeyP") {
    isPaused = true;
  }
  if (e.code === "KeyR") {
    isPaused = false;
  }
});

function spawnBlueScreen(parentSet, info, imgPath) {
  const img = document.createElement("img");
  img.src = imgPath;  // â† ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì™¸ë¶€ì—ì„œ ë„£ì„ ìˆ˜ ìˆê²Œ ë³€ê²½!

  img.className = "blue-screen-popup";
  img.style.position = "absolute";
  img.style.pointerEvents = "none";
  img.style.imageRendering = "pixelated";
  img.style.zIndex = "9";
  img.style.zIndex = "99";
  img.style.left   = info.left;
  img.style.top    = info.top;
  img.style.width  = info.width;
  img.style.height = info.height;

  parentSet.appendChild(img);
  
  playWindowsPopupSFX();

  setTimeout(() => img.remove(), 3500);
}

let stage4Started = false;
let stage5Started = false;

function checkBlueScreen() {
    const t4 = document.getElementById("stage4-trigger");
    const t5 = document.getElementById("stage5-trigger");

    if (t4 && !stage4Started) {
  const r = t4.getBoundingClientRect();

  if (r.left < window.innerWidth * 0.20 && r.right > window.innerWidth * 0.20) {
    stage4Started = true;

    // ğŸ”Š ë¸”ë£¨ ì¥ì• ë¬¼ ì†Œë¦¬ (0íšŒ / 1íšŒ ê°ê° 2ë²ˆ)
    if (t4.id === "stage4-trigger") {
      if (blueCount0 < 2) {
        playBlueSFX();
        blueCount0++;
      }
    }

    if (t4.id === "stage4-trigger-repeat") {
      if (blueCount1 < 2) {
        playBlueSFX();
        blueCount1++;
      }
    }

    blueScreens.forEach((bs, index) => {
      setTimeout(() => {
        spawnBlueScreen(gameArea, bs, "./ë…¸ì•„ ë‹¬ë¦¬ê¸° ë¸”ë£¨ìŠ¤í¬ë¦°.png");
      }, index * 120);
    });
  }
}


    if (t5 && !stage5Started) {
        const r = t5.getBoundingClientRect();

        // â­ 5ë²ˆ ë°°ê²½ë„ ë™ì¼í•œ ê±°ë¦¬ ì¡°ê±´ ì ìš©
        if (r.left < window.innerWidth * 0.20 && r.right > window.innerWidth * 0.20) {

            stage5Started = true;

            blueScreens5.forEach((bs, index) => {
                setTimeout(() => {
                    spawnBlueScreen(gameArea, bs, "./ë…¸ì•„ ë‹¬ë¦¬ê¸° ë¸”ë£¨ìŠ¤í¬ë¦° 2.png");
                }, index * 120);
            });
        }
    }
}

function checkStage5BlueSound() {
  if (!audioUnlocked) return;

  const stage5 = document.getElementById("stage5-trigger");
  const stage6 = document.getElementById("stage6");


  // â–¶ï¸ 5ë²ˆ ë°°ê²½ ì‹œì‘ â†’ ì†Œë¦¬ ON
  if (stage5 && !stage5BluePlaying) {
    const r5 = stage5.getBoundingClientRect();

    if (r5.left < window.innerWidth * 0.9) {
      stage5BluePlaying = true;
      sfxBlue5.currentTime = 0;
      sfxBlue5.volume = 0.8;
      sfxBlue5.play().catch(() => {});
    }
  }

  // ğŸ”‡ 6ë²ˆ ë°°ê²½ ì‹œì‘ í›„ ì¡°ê¸ˆ ë’¤ â†’ ì†Œë¦¬ OFF
  if (stage6 && stage5BluePlaying && !stage6BlueStopScheduled) {
    const r6 = stage6.getBoundingClientRect();

    if (r6.left < window.innerWidth * 0.4) {
      stage6BlueStopScheduled = true;

      setTimeout(() => {
        sfxBlue5.pause();
        sfxBlue5.currentTime = 0;
      }, 1200); // â­ â€œì¡°ê¸ˆ ë’¤â€ (1.2ì´ˆ)
    }
  }
}

function checkStage3Bridge() {
    const t3_0 = document.getElementById("stage3-trigger-1"); // i=0
    const t3_1 = document.getElementById("stage3-trigger-2"); // i=1

    // i=0 ë°˜ë³µ: ë¿…!
    if (t3_0 && !stage3Spawn0) {
        const r = t3_0.getBoundingClientRect();
        if (r.left < window.innerWidth * 0.30 &&
            r.right > window.innerWidth * 0.30) {
            stage3Spawn0 = true;
            spawnStage3Bridge(t3_0);
        }
    }

    // i=1 ë°˜ë³µ: ë¿…! (ì²« ë²ˆì§¸ì™€ ì™„ì „íˆ ë™ì¼)
    if (t3_1 && !stage3Spawn1) {
        const r = t3_1.getBoundingClientRect();
        if (r.left < window.innerWidth * 0.30 &&
            r.right > window.innerWidth * 0.30) {
            stage3Spawn1 = true;
            spawnStage3Bridge(t3_1);
        }
    }
}



function spawnStage3Bridge(target) {
  playBridgeSFX(); 
    const spawnLeft = noahX + 6.5;

    const bridge = document.createElement("div");
    bridge.className = "bridgeBlock";
    bridge.style.left = spawnLeft + "%";
    bridge.style.bottom = "15%";
    bridge.style.width = "50%";
    bridge.style.height = "60%";
    bridge.style.backgroundImage = "url('./ë…¸ì•„ ë‹¬ë¦¬ê¸° ë‹¤ë¦¬.png')";
    bridge.style.backgroundSize = "100% 100%";
    bridge.style.position = "absolute";
    bridge.style.imageRendering = "pixelated";
    bridge.style.zIndex = "8";
    target.appendChild(bridge);

    const platform = document.createElement("div");
    platform.className = "platformBlock";
    platform.style.left = (spawnLeft + 10) + "%";
    platform.style.bottom = "42.5%";
    platform.style.width = "30%";
    platform.style.height = "5%";
    platform.style.position = "absolute";
    platform.style.background = "rgba(255,0,0,0)";
    platform.style.zIndex = "99";
    target.appendChild(platform);

    bridge.style.animation = "bridgePop 0.35s cubic-bezier(0.2, 1.4, 0.4, 1)";
}

function checkStage6Falling() {
    const s0 = document.getElementById("stage6");         // i=0 ì„¸íŠ¸
    const s1 = document.getElementById("stage6-repeat");  // i=1 ì„¸íŠ¸

    const hb = hitbox.getBoundingClientRect();
    const noahCenter = hb.left + hb.width * 0.5;

    // -------------------------
    // ğŸ”¥ i = 0 ë°˜ë³µ
    // -------------------------
    if (s0 && !stage6Fall0) {
        const r = s0.getBoundingClientRect();

        // ë…¸ì•„ê°€ ë°°ê²½ì˜ 30~70% ì˜ì—­ì„ í†µê³¼í–ˆì„ ë•Œ ì¿µ ìƒì„±
        const triggerL = r.left + r.width * 0.3;
        const triggerR = r.left + r.width * 0.7;

        if (noahCenter > triggerL && noahCenter < triggerR) {

            stage6Fall0 = true;

            fallObstacleInfo[6].forEach(f => {
                setTimeout(() => {
                    spawnFallingObstacle(f, s0, 6);
                }, f.delay || 0);
            });
        }
    }

    // -------------------------
    // ğŸ”¥ i = 1 ë°˜ë³µ
    // -------------------------
    if (s1 && !stage6Fall1) {
        const r = s1.getBoundingClientRect();

        const triggerL = r.left + r.width * 0.1;
        const triggerR = r.left + r.width * 0.3;

        if (noahCenter > triggerL && noahCenter < triggerR) {

            stage6Fall1 = true;

            fallObstacleInfo[6].forEach(f => {
                setTimeout(() => {
                    spawnFallingObstacle(f, s1, 6);
                }, f.delay || 0);
            });
        }
    }
}

let lightningTriggered0 = false;
let lightningTriggered1 = false;

function checkLightningTrigger() {
    const t3_0 = document.getElementById("stage3-trigger-1"); 
    const t3_1 = document.getElementById("stage3-trigger-2"); 
    const hb = hitbox.getBoundingClientRect();
    const noahCenter = hb.left + hb.width * 0.5;

    // i=0 ì„¸íŠ¸
    if (t3_0 && !lightningTriggered0) {
        const rect = t3_0.getBoundingClientRect();

        if (noahCenter > rect.left + rect.width * 0.25 &&
            noahCenter < rect.left + rect.width * 0.65) {

            lightningTriggered0 = true;
            activateLightning(t3_0);
        }
    }

    // i=1 ì„¸íŠ¸
    if (t3_1 && !lightningTriggered1) {
        const rect = t3_1.getBoundingClientRect();

        if (noahCenter > rect.left + rect.width * 0.25 &&
            noahCenter < rect.left + rect.width * 0.65) {

            lightningTriggered1 = true;
            activateLightning(t3_1);
        }
    }
}

function activateLightning(targetSet) {
  const sparks = targetSet.querySelectorAll(".spark");
  const loops  = targetSet.querySelectorAll(".sparkLoop");

  sparks.forEach(s => s.style.display = "none");
  loops.forEach(l => l.style.display = "block");

  // ğŸ”Š ì „ê¸° ì‚¬ìš´ë“œ ì œì–´
  if (targetSet.id === "stage3-trigger-1") {
    // 0íšŒ ë°˜ë³µ
    if (electricCount0 < 2) {
      playElectricSFX();
      electricCount0++;
    }
  }

  if (targetSet.id === "stage3-trigger-2") {
    // 1íšŒ ë°˜ë³µ
    if (electricCount1 < 2) {
      playElectricSFX();
      electricCount1++;
    }
  }
}



/* ===================================================================
   GAME LOOP
=================================================================== */

function gameLoop() {

checkBlueScreen();



  // â­ ì—”ë”© ìë™ ë‹¬ë¦¬ê¸° ëª¨ë“œ
  if (finalRun) {
      noahX += 0.3;               // % ë‹¨ìœ„ ì´ë™
      noah.style.left = noahX + "%";

      if (noahX > 110) {
          window.location.href = "noah fight.html";
      }

      requestAnimationFrame(gameLoop);
      return;
  }

  if (isPaused) {
    requestAnimationFrame(gameLoop);
    return;
  }
 moveBackground();
 checkStage3Bridge();
 checkStage6Falling();
 checkLightningTrigger();
 checkStage2PaperSound();
checkStage5BlueSound();



  /* ì¤‘ë ¥ */
  vy -= 0.03;
  y += vy;

  const hb = hitbox.getBoundingClientRect();

  /* =====================================================
     ğŸŸ¡ ì°©ì§€ íŒì • (groundBlockë§Œ)
  ===================================================== */

  const grounds = [...document.querySelectorAll(".groundBlock, .platformBlock")]
  .filter(el => !el.classList.contains("item"));  // ì•„ì´í…œ ì•„ë˜ platform ë¬´íš¨í™”



  let landed = false;
  let groundTopVH = null;

  
  for (let plat of grounds) {

  // â­ ì•„ì´í…œ ìœ„ëŠ” ì°©ì§€ë¡œ íŒì •í•˜ì§€ ì•Šê¸°
  if (plat.classList.contains("item")) continue;

  const p = plat.getBoundingClientRect();

  const horizontally = hb.right > p.left && hb.left < p.right;
  const isFalling = vy <= 0;

  const justLanded =
    isFalling &&
    hb.bottom >= p.top - 10 &&
    hb.bottom <= p.top + 20;

  if (horizontally && justLanded) {
    groundTopVH = (window.innerHeight - p.top) / window.innerHeight * 100;
    landed = true;
    break;
  }
}


  if (landed) {
    y = groundTopVH - 10;
    vy = 0;
    onGround = true;

    if (currentAction === "jump") setNoahAction("run");

  } else {
    onGround = false;   // â† â˜… ë°˜ë“œì‹œ falseì—¬ì•¼ ì í”„ ì •ìƒ ì‘ë™
  }


  /* =====================================================
     ğŸŸ¡ ì¶”ë½ ì‚¬ë§ íŒì •
  ===================================================== */
  if (!landed && y < -20) {
    triggerGameOver();
    return;
  }


  /* =====================================================
     ğŸŸ¡ ì¼ë°˜ ì¥ì• ë¬¼ ì¶©ëŒ
  ===================================================== */
  /* =====================================================
   ğŸŸ¡ ì¼ë°˜ ì¥ì• ë¬¼ ì¶©ëŒ (íˆíŠ¸ë°•ìŠ¤ í¬ê²Œ ìœ ì§€í•˜ë©´ì„œë„ ì¦‰ì‚¬ ë°©ì§€)
===================================================== */
const obstacles = document.querySelectorAll(".obstacle");

for (let ob of obstacles) {
  const r = ob.getBoundingClientRect();

  // â­ ì¥ì• ë¬¼ íŒì •ì„ ì‹¤ì œ ëª¸í†µ ë¶€ë¶„ìœ¼ë¡œ ì¶•ì†Œ
  const o = {
    left:   r.left + r.width * 0.15,    // ì–‘ìª½ 15% ì˜ë¼ë‚´ê¸°
    right:  r.right - r.width * 0.15,
    top:    r.top + r.height * 0.15,    // ìœ„ìª½ ì—¬ë°± ì œê±°
    bottom: r.bottom - r.height * 0.05  // ì•„ë˜ëŠ” ì—¬ë°± ê±°ì˜ ì—†ìŒ
  };

  const hit =
    hb.right > o.left &&
    hb.left < o.right &&
    hb.bottom > o.top &&
    hb.top < o.bottom;

  if (hit) {
    triggerGameOver();
    return;
  }
}

/* =====================================================
   âš¡ ë²ˆê°œ ì¶©ëŒ â†’ ì¦‰ì‚¬ (íŒì • ì™„í™” ë²„ì „)
===================================================== */
const lightnings = document.querySelectorAll(".sparkLoop");

for (let lg of lightnings) {
  const r = lg.getBoundingClientRect();

  // í™”ë©´ ë°– ë²ˆê°œëŠ” ë¬´ì‹œ
  if (r.right < 0 || r.left > window.innerWidth) continue;

  // â­ íŒì • ì¶•ì†Œ (ì¤‘ì•™ë¶€ë§Œ ìœ„í—˜)
  const o = {
    left:   r.left + r.width  * 0.5,  // ì¢Œìš° 25% ì»·
    right:  r.right - r.width * 0.5,
    top:    r.top + r.height  * 0.15,  // ìœ„ìª½ ì—¬ë°±
    bottom: r.bottom - r.height * 0.10 // ì•„ë˜ ì—¬ë°±
  };

  const hit =
    hb.right > o.left &&
    hb.left < o.right &&
    hb.bottom > o.top &&
    hb.top < o.bottom;

  if (hit) {
    triggerGameOver();
    return;
  }
}


/* =====================================================
   ğŸ”µ ë¸”ë£¨ ì¥ì• ë¬¼ ì¶©ëŒ â†’ ì¦‰ì‚¬ (íŒì • ì™„í™” ë²„ì „)
===================================================== */
const blueObstacles = document.querySelectorAll(
  ".obstacle-stage4, .obstacle-stage5"
);

for (let bo of blueObstacles) {
  const r = bo.getBoundingClientRect();

  // í™”ë©´ ë°– ë¬´ì‹œ
  if (r.right < 0 || r.left > window.innerWidth) continue;

  // â­ íŒì • ì¶•ì†Œ (ì¤‘ì•™ë¶€ë§Œ ìœ„í—˜)
  const o = {
    left:   r.left + r.width  * 0.5,   // ì¢Œìš° ì—¬ë°±
    right:  r.right - r.width * 0.5,
    top:    r.top + r.height  * 0.18,   // ìœ„ ì—¬ë°±
    bottom: r.bottom - r.height * 0.12  // ì•„ë˜ ì—¬ë°±
  };

  const hit =
    hb.right > o.left &&
    hb.left < o.right &&
    hb.bottom > o.top &&
    hb.top < o.bottom;

  if (hit) {
    triggerGameOver();
    return;
  }
}



  /* =====================================================
     ğŸŸ¡ ì¿µ ì¥ì• ë¬¼ ì¶©ëŒ â†’ ë°ë¯¸ì§€ ì²˜ë¦¬
  ===================================================== */
  /* =====================================================
   ğŸŸ¡ ì¿µ ì¥ì• ë¬¼ ì¶©ëŒ â†’ ë°ë¯¸ì§€ ì²˜ë¦¬
===================================================== */
const fixedObs = [...document.querySelectorAll(".groundObstacle")]
  .filter(fo => {
    const o = fo.getBoundingClientRect();
    return o.right > 0 && o.left < window.innerWidth;
  });

for (let fo of fixedObs) {

  if (fo.dataset.hit === "1") continue;

  const r = fo.getBoundingClientRect();

// â­ ì¶©ëŒ ë°•ìŠ¤ ì‹¤ì œë¡œ ì¢íˆê¸° (ì¤‘ì‹¬ë¶€ë§Œ íŒì •)
// ì•„ë˜ì™€ ì™¼ìª½ìª½ì˜ íŒì •ì„ í¬ê²Œ ì œê±°!
const o = {
  left:   r.left + (r.width * 0.15),     // ì™¼ìª½ 35% ì œê±° â†’ ì™¼ìª½ ìŠ¤ì¹¨ ëª¨ë‘ ë¬´ì‹œë¨
  right:  r.right - (r.width * 0.15),    // ì˜¤ë¥¸ìª½ 15% ì œê±°
  top:    r.top + (r.height * 0.10),     // ìœ„ìª½ íŒì • ì¶•ì†Œ
  bottom: r.bottom - (r.height * 0.12)   // ì•„ë˜ìª½ íŒì • í¬ê²Œ ì¶•ì†Œ
};


  const hit =
    hb.right > o.left &&
    hb.left < o.right &&
    hb.bottom > o.top &&
    hb.top < o.bottom;

  if (hit) {

  // â­ ì§„ì§œë¡œ ê²¹ì³¤ì„ ë•Œë§Œ ë°ë¯¸ì§€
  handleFallingObstacleHit();
  fo.dataset.hit = "1";

  break;
}

}
/* =====================================
   ğŸŸ¡ ì•„ì´í…œ ë¨¹ê¸° íŒì •
===================================== */
document.querySelectorAll(".item").forEach(item => {
  const type = item.dataset.type;
  const r = item.getBoundingClientRect();

  // â­ ê°€ì¥ ì¤‘ìš”í•œ ìµœì í™”! í™”ë©´ ë°– ì•„ì´í…œì€ ê²€ì‚¬ ì•ˆ í•¨
  if (r.right < 0 || r.left > window.innerWidth) return;

  const hit =
    hb.right > r.left &&
    hb.left < r.right &&
    hb.bottom > r.top &&
    hb.top < r.bottom;

  if (hit) {
  playItemSFX();   // â­ ì—¬ê¸°!! ì´ ì¤„!!

  item.style.transition = "0.2s ease-out";
  item.style.transform = "translateY(-20px) scale(0)";
  setTimeout(() => item.remove(), 200);
  console.log("íšë“:", itemScore[type]);
}

});



  /* =====================================================
     ğŸŸ¡ ë…¸ì•„ ìœ„ì¹˜ ë°˜ì˜
  ===================================================== */
  noah.style.bottom = (10 + y) + "%";
  hitbox.style.bottom = (10 + y) + "%";
  hitbox.style.left =
    (noah.offsetLeft + noah.offsetWidth * 0.25) + "px";

  requestAnimationFrame(gameLoop);
}

gameLoop();



/* ===================================================================
   ì´ˆê¸° ìœ„ì¹˜ ë³´ì •
=================================================================== */
setTimeout(() => {
  const firstGround = document.querySelector(".groundBlock");
  if (!firstGround) return;

  const g = firstGround.getBoundingClientRect();
  const groundTop = (window.innerHeight - g.top) / window.innerHeight * 100;

  noah.style.bottom = (groundTop - 10) + "%";
}, 50);




/* ===================================================================
   í™”ë©´ í”ë“¤ë¦¼ íš¨ê³¼
=================================================================== */

function screenShake() {
  const area = document.querySelector(".game-area");
  area.style.transition = "transform 0.05s";

  let shakeCount = 0;

  const shakeInterval = setInterval(() => {
    area.style.transform =
      `translate(${(Math.random() - 0.5) * 10}px, ${(Math.random() - 0.5) * 30}px)`;

    shakeCount++;
    if (shakeCount > 10) {
      clearInterval(shakeInterval);
      area.style.transform = "translate(0,0)";
    }
  }, 50);
}


window.addEventListener("resize", () => {
  // ì¤Œ ë³€ë™ ê°ì§€ë˜ë©´ 0.5ì´ˆ ë™ì•ˆ ëª¨ë“  íŠ¸ë¦¬ê±° OFF
  disableTriggersUntil = performance.now() + 500;
});

/* ==========================
   GAME OVER ì²˜ë¦¬
========================== */
function triggerGameOver() {
  if (isDead) return;

  isDead = true;
  isPaused = true;

  // ë…¸ì•„ ì£½ìŒ ì´ë¯¸ì§€
  noah.src = "./ë…¸ì•„ ì£½ìŒ.png";

  // ë‹¤ì‹œí•˜ê¸° ì˜¤ë²„ë ˆì´ í‘œì‹œ (â­ í•µì‹¬)
  const overlay = document.getElementById("retry-overlay");
  if (overlay) {
    overlay.style.display = "flex";
  }
}

document.getElementById("retry-btn").addEventListener("click", () => {
  location.reload();
});


</script>
</body>
</html>













